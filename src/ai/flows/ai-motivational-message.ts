
'use server';
/**
 * @fileOverview An AI flow to generate a personalized motivational message
 * incorporating weather, events, tasks, and health reminders.
 */

console.log('<<<<< DEBUG: ai-motivational-message.ts SCRIPT EXECUTING - TOP OF FILE >>>>>');

import {ai} from '@/ai/genkit';
import {z} from 'zod';

const MotivationalMessageInputSchema = z.object({
  userName: z.string().describe('The name of the user.'),
  currentWeatherSummary: z.string().optional().describe("A brief summary of the current weather (e.g., 'Antalya: 25Â°C, GÃ¼neÅŸli'). Can be empty."),
  todaysEvents: z.array(z.string()).optional().describe("A list of today's scheduled calendar event titles. Can be empty."),
  userTasksSummary: z.array(z.string()).optional().describe('A list of summaries for active tasks assigned to the user (e.g., "Raporu tamamla (Devam Ediyor)"). Can be empty.'),
  overdueTasksSummary: z.array(z.string()).optional().describe('A list of summaries for overdue tasks assigned to the user (e.g., "Sunumu hazÄ±rla (YapÄ±lacak)"). Can be empty.'),
});
export type MotivationalMessageInput = z.infer<typeof MotivationalMessageInputSchema>;

const MotivationalMessageOutputSchema = z.object({
  message: z.string().describe('The personalized, motivational, and informative message generated by the AI in Turkish.'),
});
export type MotivationalMessageOutput = z.infer<typeof MotivationalMessageOutputSchema>;

const motivationalPrompt = ai.definePrompt({
  name: 'enhancedMotivationalMessagePrompt_v1',
  input: {schema: MotivationalMessageInputSchema},
  output: {schema: MotivationalMessageOutputSchema},
  prompt: `Sen, ofis ortamÄ±nda Ã§alÄ±ÅŸanlar iÃ§in son derece arkadaÅŸ canlÄ±sÄ±, motive edici, esprili ve yardÄ±msever bir asistansÄ±n. {{userName}} iÃ§in TÃ¼rkÃ§e, kiÅŸiselleÅŸtirilmiÅŸ ve gÃ¼nlÃ¼k hayatÄ±nÄ± kolaylaÅŸtÄ±racak bir mesaj oluÅŸtur.

MesajÄ±nda aÅŸaÄŸÄ±daki unsurlarÄ± dengeli bir ÅŸekilde kullanmaya Ã§alÄ±ÅŸ:

1.  **Hitap ve Genel Motivasyon:** {{userName}}'e ismiyle hitap et ve gÃ¼ne pozitif baÅŸlamasÄ±nÄ± saÄŸla.
2.  **GecikmiÅŸ GÃ¶revler (Ã–NCELÄ°KLÄ°!):** EÄŸer varsa, gecikmiÅŸ gÃ¶revleri esprili bir dille ama Ã¶nemini belirterek hatÄ±rlat. BaÅŸÄ±na â— emojisi koyabilirsin.
    {{#if overdueTasksSummary}}
    Aman {{userName}}, ÅŸu iÅŸlere bir el atsan iyi olur:
    {{#each overdueTasksSummary}}
    - â— {{{this}}}
    {{/each}}
    Unutma, "BugÃ¼nÃ¼n iÅŸini yarÄ±na bÄ±rakma!" derler, sonra yetiÅŸtiremeyince "KeÅŸke yapsaydÄ±m!" deme. ğŸ˜‰
    {{/if}}
3.  **Aktif GÃ¶revler:** EÄŸer varsa, devam eden gÃ¶revlerinden birkaÃ§Ä±nÄ± hatÄ±rlat.
    {{#if userTasksSummary}}
    Åu anda Ã¼zerinde Ã§alÄ±ÅŸtÄ±ÄŸÄ±n bazÄ± konular var gibi, kolay gelsin!
    {{#each userTasksSummary}}
    - {{{this}}}
    {{/each}}
    {{/if}}
4.  **BugÃ¼nÃ¼n Etkinlikleri (Ã–nÃ¼mÃ¼zdeki 7 gÃ¼n iÃ§in veri henÃ¼z yok, sadece bugÃ¼n):** EÄŸer varsa, bugÃ¼nÃ¼n takvim etkinliklerinden bahset.
    {{#if todaysEvents}}
    BugÃ¼n takviminde ÅŸunlar gÃ¶rÃ¼nÃ¼yor:
    {{#each todaysEvents}}
    - {{{this}}}
    {{/each}}
    UmarÄ±m hepsi harika geÃ§er!
    {{/if}}
5.  **Hava Durumu Tavsiyesi:** EÄŸer hava durumu bilgisi varsa ({{currentWeatherSummary}}), buna uygun kÄ±sa bir tavsiye ver. (Ã–rn: "Hava gÃ¼neÅŸliyse bir ara D vitamini almayÄ± unutma!", "YaÄŸmurluysa ÅŸemsiyeni kap!")
    {{#if currentWeatherSummary}}
    Bu arada, {{currentWeatherSummary}}.
    {{#if (lookup currentWeatherSummary "toLowerCase" | includes "gÃ¼neÅŸli")}}
    Hava pÄ±rÄ±l pÄ±rÄ±l gÃ¶rÃ¼nÃ¼yor, belki Ã¶ÄŸle arasÄ±nda kÄ±sa bir yÃ¼rÃ¼yÃ¼ÅŸ iyi gelir? â˜€ï¸
    {{else if (lookup currentWeatherSummary "toLowerCase" | includes "yaÄŸmurlu")}}
    YaÄŸmur varsa ÅŸemsiyeni ve pozitif enerjini yanÄ±na almayÄ± unutma! â˜”ï¸
    {{else if (lookup currentWeatherSummary "toLowerCase" | includes "bulutlu")}}
    Hava biraz kapalÄ± olsa da, senin enerjin ortamÄ± aydÄ±nlatÄ±r! â˜ï¸
    {{else if (lookup currentWeatherSummary "toLowerCase" | includes "kar yaÄŸÄ±ÅŸlÄ±")}}
    DÄ±ÅŸarÄ±sÄ± bembeyazsa, sÄ±cak bir iÃ§ecekle keyif yapma zamanÄ±! â„ï¸
    {{else}}
    Hava durumuna gÃ¶re giyinmeyi ve gÃ¼nÃ¼n tadÄ±nÄ± Ã§Ä±karmayÄ± unutma!
    {{/if}}
    {{/if}}
6.  **SaÄŸlÄ±k HatÄ±rlatmalarÄ± (Rastgele ve esprili):**
    *   Arada bir "Bir bardak su iÃ§tin mi? Beynimizin yakÄ±tÄ± o!" gibi bir hatÄ±rlatma ekle.
    *   Veya "EÄŸer uzun sÃ¼redir oturuyorsan, kalk bir 45 saniye esneme molasÄ± ver, kan dolaÅŸÄ±mÄ±n bayram etsin!" gibi.
    *   (Bu hatÄ±rlatmalardan sadece birini veya hiÃ§birini kullanabilirsin, mesaja doÄŸallÄ±k katacak ÅŸekilde.)
7.  **Ofis HayatÄ±nÄ± KolaylaÅŸtÄ±rÄ±cÄ± Tavsiye (Rastgele):**
    *   "BugÃ¼n masandaki bir ÅŸeyi dÃ¼zenleyerek baÅŸla, kÃ¼Ã§Ã¼k bir ferahlÄ±k bÃ¼yÃ¼k motivasyon getirir."
    *   "En zorlandÄ±ÄŸÄ±n iÅŸe odaklanmadan Ã¶nce 5 dakika sevdiÄŸin bir mÃ¼zik dinle."
    *   (Bu tavsiyelerden sadece birini veya hiÃ§birini kullanabilirsin.)
8.  **KapanÄ±ÅŸ:** MesajÄ± pozitif ve motive edici bir ÅŸekilde bitir.

Ã–rnek Ã‡Ä±ktÄ± FormatÄ± (JSON):
{
  "message": "Merhaba {{userName}}, bugÃ¼n harika iÅŸler baÅŸaracaÄŸÄ±na eminim! â— 'Acil Rapor' gÃ¶revin gecikmiÅŸ gÃ¶rÃ¼nÃ¼yor, bir baksan iyi olur. BugÃ¼n takviminde 'Pazarlama ToplantÄ±sÄ±' var. Hava da gÃ¼neÅŸliymiÅŸ, bir ara D vitamini almayÄ± unutma! ğŸ˜‰ Bol enerjili bir gÃ¼n dilerim!"
}

LÃœTFEN YANITINI SADECE Ä°STENEN JSON FORMATINDA VER, BAÅKA HÄ°Ã‡BÄ°R AÃ‡IKLAMA EKLEME.
Girdi:
KullanÄ±cÄ± AdÄ±: {{userName}}
{{#if currentWeatherSummary}}Hava Durumu: {{currentWeatherSummary}}{{/if}}
{{#if todaysEvents}}BugÃ¼nÃ¼n Etkinlikleri: {{#each todaysEvents}} {{{this}}}; {{/each}}{{/if}}
{{#if userTasksSummary}}Aktif GÃ¶revler: {{#each userTasksSummary}} {{{this}}}; {{/each}}{{/if}}
{{#if overdueTasksSummary}}GecikmiÅŸ GÃ¶revler: {{#each overdueTasksSummary}} {{{this}}}; {{/each}}{{/if}}
`,
  config: {
    // Gemini safety filters - adjust as needed, be less restrictive for general advice
    safetySettings: [
      { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
      { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
      { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
      { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
    ],
  }
});

export async function generateMotivationalMessage(input: MotivationalMessageInput): Promise<MotivationalMessageOutput> {
  console.log('<<<<< DEBUG: generateMotivationalMessage FUNCTION CALLED (ENHANCED) >>>>>');
  const apiKeyExists = !!process.env.GOOGLE_API_KEY;
  const apiKeyLength = process.env.GOOGLE_API_KEY?.length || 0;
  console.log(`[AI Motivational Flow - ENHANCED DEBUG] GOOGLE_API_KEY Check: Exists: ${apiKeyExists}, Length (approx): ${apiKeyLength > 0 ? 'Non-zero' : 'Zero'}`);
  console.log(`[AI Motivational Flow - ENHANCED DEBUG] ENTERING for user: ${input.userName}. Full input received: ${JSON.stringify(input)}`);

  try {
    console.log(`[AI Motivational Flow - ENHANCED DEBUG] CALLING ENHANCED PROMPT (enhancedMotivationalMessagePrompt_v1) with input: ${JSON.stringify(input)}`);
    const {output} = await motivationalPrompt(input);

    console.log(`[AI Motivational Flow - ENHANCED DEBUG] RAW OUTPUT from enhancedMotivationalMessagePrompt_v1 for ${input.userName}:`, output);

    if (output && typeof output.message === 'string' && output.message.trim() !== '') {
      console.log(`[AI Motivational Flow - ENHANCED DEBUG] SUCCESS for ${input.userName}. Parsed message: "${output.message.trim()}"`);
      return {message: output.message.trim()};
    }

    const rawResponseForLog = output ? JSON.stringify(output) : "Output was undefined or not in expected schema";
    console.warn(`[AI Motivational Flow - ENHANCED DEBUG] AI message prompt returned null, empty message, or malformed output for user ${input.userName}. Parsed output: ${rawResponseForLog}. Falling back.`);
    return {message: `Merhaba ${input.userName}, sana Ã¶zel mesaj ÅŸu anda oluÅŸturulamadÄ± ama harika bir gÃ¼n geÃ§irmeni dilerim! (Kod: FALLBACK_ENHANCED)`};

  } catch (promptError: any) {
    console.error(
      `[AI Motivational Flow - ENHANCED DEBUG] CRITICAL PROMPT ERROR - ENHANCED (enhancedMotivationalMessagePrompt_v1) for user ${input.userName}.
      Error Name: ${promptError.name}
      Message: ${promptError.message}
      Input to prompt: ${JSON.stringify(input)}
      Stack: ${promptError.stack || 'No stack available'}
      Falling back.`
    );
    return {message: `Merhaba ${input.userName}, AI mesajÄ± oluÅŸturulurken bir sunucu hatasÄ± oluÅŸtu (Kod: PROMPT_EXEC_FAIL_ENHANCED). API anahtarÄ±nÄ±zÄ± ve model eriÅŸiminizi kontrol etmeniz gerekebilir.`};
  }
}
