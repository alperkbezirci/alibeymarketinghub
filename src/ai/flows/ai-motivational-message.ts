
'use server';
/**
 * @fileOverview An AI flow to generate a personalized motivational message
 * incorporating events and tasks.
 */

console.log('<<<<< DEBUG: ai-motivational-message.ts SCRIPT EXECUTING - TOP OF FILE >>>>>');

import {ai} from '@/ai/genkit';
import {z} from 'zod';

const MotivationalMessageInputSchema = z.object({
  userName: z.string().describe('The name of the user.'),
  // todaysEvents and userTasksSummary are optional as they might not always be present
  todaysEvents: z.array(z.string()).optional().describe("A list of today's scheduled calendar event titles. Can be empty."),
  userTasksSummary: z.array(z.string()).optional().describe('A list of summaries for active tasks assigned to the user (e.g., "Raporu tamamla (Devam Ediyor)"). Can be empty.'),
  overdueTasksSummary: z.array(z.string()).optional().describe('A list of summaries for overdue tasks assigned to the user (e.g., "Sunumu hazÄ±rla (YapÄ±lacak)"). Can be empty.'),
});
export type MotivationalMessageInput = z.infer<typeof MotivationalMessageInputSchema>;

const MotivationalMessageOutputSchema = z.object({
  message: z.string().describe('The personalized, motivational, and informative message generated by the AI in Turkish.'),
});
export type MotivationalMessageOutput = z.infer<typeof MotivationalMessageOutputSchema>;

const motivationalPrompt = ai.definePrompt({
  name: 'jsonMotivationalPrompt_v3_debug', // Kept a unique name from previous successful state
  input: {schema: MotivationalMessageInputSchema},
  output: {schema: MotivationalMessageOutputSchema},
  prompt: `Sen, ofis ortamÄ±nda Ã§alÄ±ÅŸanlar iÃ§in son derece arkadaÅŸ canlÄ±sÄ±, motive edici ve yardÄ±msever bir asistansÄ±n. {{userName}} iÃ§in TÃ¼rkÃ§e, kiÅŸiselleÅŸtirilmiÅŸ ve gÃ¼nlÃ¼k hayatÄ±nÄ± kolaylaÅŸtÄ±racak bir mesaj oluÅŸtur.

MesajÄ±nda aÅŸaÄŸÄ±daki unsurlarÄ± dengeli bir ÅŸekilde kullanmaya Ã§alÄ±ÅŸ:

1.  **Hitap ve Genel Motivasyon:** {{userName}}'e ismiyle hitap et ve gÃ¼ne pozitif baÅŸlamasÄ±nÄ± saÄŸla.
2.  **GecikmiÅŸ GÃ¶revler (Ã–NCELÄ°KLÄ°!):** EÄŸer varsa, gecikmiÅŸ gÃ¶revleri kÄ±saca hatÄ±rlat. BaÅŸÄ±na â— emojisi koy.
    {{#if overdueTasksSummary}}
    Aman {{userName}}, ÅŸu iÅŸlere bir el atsan iyi olur:
    {{#each overdueTasksSummary}}
    - â— {{{this}}}
    {{/each}}
    Unutma, "BugÃ¼nÃ¼n iÅŸini yarÄ±na bÄ±rakma!" ğŸ˜‰
    {{/if}}
3.  **Aktif GÃ¶revler:** EÄŸer varsa, devam eden gÃ¶revlerinden birkaÃ§Ä±nÄ± hatÄ±rlat.
    {{#if userTasksSummary}}
    Åu anda Ã¼zerinde Ã§alÄ±ÅŸtÄ±ÄŸÄ±n bazÄ± konular var gibi, kolay gelsin!
    {{#each userTasksSummary}}
    - {{{this}}}
    {{/each}}
    {{/if}}
4.  **BugÃ¼nÃ¼n Etkinlikleri:** EÄŸer varsa, bugÃ¼nÃ¼n takvim etkinliklerinden bahset.
    {{#if todaysEvents}}
    BugÃ¼n takviminde ÅŸunlar gÃ¶rÃ¼nÃ¼yor:
    {{#each todaysEvents}}
    - {{{this}}}
    {{/each}}
    UmarÄ±m hepsi harika geÃ§er!
    {{/if}}
5.  **KapanÄ±ÅŸ:** MesajÄ± pozitif ve motive edici bir ÅŸekilde bitir.

Ã–rnek Ã‡Ä±ktÄ± FormatÄ± (JSON):
{
  "message": "Merhaba {{userName}}, bugÃ¼n harika iÅŸler baÅŸaracaÄŸÄ±na eminim! BugÃ¼n takviminde 'Pazarlama ToplantÄ±sÄ±' var. Bol enerjili bir gÃ¼n dilerim!"
}

LÃœTFEN YANITINI SADECE Ä°STENEN JSON FORMATINDA VER, BAÅKA HÄ°Ã‡BÄ°R AÃ‡IKLAMA EKLEME.
Girdi:
KullanÄ±cÄ± AdÄ±: {{userName}}
{{#if todaysEvents}}BugÃ¼nÃ¼n Etkinlikleri: {{#each todaysEvents}} {{{this}}}; {{/each}}{{/if}}
{{#if userTasksSummary}}Aktif GÃ¶revler: {{#each userTasksSummary}} {{{this}}}; {{/each}}{{/if}}
{{#if overdueTasksSummary}}GecikmiÅŸ GÃ¶revler: {{#each overdueTasksSummary}} {{{this}}}; {{/each}}{{/if}}
`,
  config: {
    // Gemini safety filters - adjust as needed
    safetySettings: [
      { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
      { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
      { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
      { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' },
    ],
  }
});

export async function generateMotivationalMessage(input: MotivationalMessageInput): Promise<MotivationalMessageOutput> {
  console.log('<<<<< DEBUG: generateMotivationalMessage FUNCTION CALLED (JSON V3 DEBUG) >>>>>');
  const apiKeyExists = !!process.env.GOOGLE_API_KEY;
  const apiKeyLength = process.env.GOOGLE_API_KEY?.length || 0;
  console.log(`[AI Motivational Flow - JSON DEBUG] GOOGLE_API_KEY Check: Exists: ${apiKeyExists}, Length (approx): ${apiKeyLength > 0 ? 'Non-zero' : 'Zero'}`);
  console.log(`[AI Motivational Flow - JSON DEBUG] ENTERING for user: ${input.userName}. Full input received: ${JSON.stringify(input)}`);

  try {
    console.log(`[AI Motivational Flow - JSON DEBUG] CALLING JSON PROMPT (jsonMotivationalPrompt_v3_debug) with input: ${JSON.stringify(input)}`);
    const response = await motivationalPrompt(input);
    const modelOutput = response.output; // Genkit 1.x: output is already parsed if schema is provided

    console.log(`[AI Motivational Flow - JSON DEBUG] RAW RESPONSE from jsonMotivationalPrompt_v3_debug for ${input.userName}:`, response.raw?.choices[0]?.message?.content);
    console.log(`[AI Motivational Flow - JSON DEBUG] PARSED OUTPUT from jsonMotivationalPrompt_v3_debug for ${input.userName}:`, modelOutput);

    if (modelOutput && typeof modelOutput.message === 'string' && modelOutput.message.trim() !== '') {
      console.log(`[AI Motivational Flow - JSON DEBUG] SUCCESS for ${input.userName}. Parsed message: "${modelOutput.message.trim()}"`);
      return {message: modelOutput.message.trim()};
    }
    
    const rawResponseForLog = modelOutput ? JSON.stringify(modelOutput) : "Output was undefined or not in expected schema";
    console.warn(`[AI Motivational Flow - JSON DEBUG] AI message prompt returned null, empty message, or malformed output for user ${input.userName}. Parsed output: ${rawResponseForLog}. Falling back.`);
    return {message: `Merhaba ${input.userName}, sana Ã¶zel mesaj ÅŸu anda oluÅŸturulamadÄ± ama harika bir gÃ¼n geÃ§irmeni dilerim! (Kod: FALLBACK_JSON_V3_DEBUG)`};

  } catch (promptError: any) {
    console.error(
      `[AI Motivational Flow - JSON DEBUG] CRITICAL PROMPT ERROR - JSON (jsonMotivationalPrompt_v3_debug) for user ${input.userName}.
      Error Name: ${promptError.name}
      Message: ${promptError.message}
      Input to prompt: ${JSON.stringify(input)}
      Stack: ${promptError.stack || 'No stack available'}
      Falling back.`
    );
    return {message: `Merhaba ${input.userName}, AI mesajÄ± oluÅŸturulurken bir sunucu hatasÄ± oluÅŸtu (Kod: PROMPT_EXEC_FAIL_JSON_V3_DEBUG). API anahtarÄ±nÄ±zÄ± ve model eriÅŸiminizi kontrol etmeniz gerekebilir.`};
  }
}
